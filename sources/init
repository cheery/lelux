#!/bin/ash
/bin/busybox mkdir -p usr/bin usr/sbin sys proc dev tmp sbin etc
/bin/busybox --install

export PATH=/usr/local/bin:/bin:/usr/bin:/sbin

# first we mount some filesystems and set the hostname
mount -t devtmpfs devfs /dev
mount -t proc proc /proc
mount -t sysfs sysfs /sys
mount -t tmpfs tmpfs /tmp

hostname lelux

# relevant for people who wonder about how ip commands relate to ifconfig commands:
# http://www.tty1.net/blog/2010-04-21-ifconfig-ip-comparison_en.html

# next we bring loopback device and eth0 up
# and configure them
# once we're done, we select the default route to the internet
ip link set lo up
ip link set eth0 up
ip address add 10.0.2.15/24 broadcast + dev eth0
ip route add default via 10.0.2.2

# then we provide a nameserver so DNS requests can resolve
cat > /etc/resolv.conf << EOF
# autogenerated by /init
nameserver 10.0.2.3
EOF

# rest of these files are here to centralize configuration
# in most cases these files would be static anyway, but 
# most modern desktops autoconfigure their network devices
cat > /etc/hosts << EOF
# autogenerated by /init
127.0.0.1   localhost
127.0.1.1   lelux
EOF

# these files do not usually get configured at the boot
cat > /etc/nsswitch.conf << EOF
# autogenerated by /init
hosts:      files dns
EOF

cat > /etc/lelux-version << EOF
# autogenerated by /init
lelux-0.1
EOF

echo 0 > /proc/sys/kernel/printk # Disable kernel messages 
exec /bin/ash

# # "get teletype" into tty0
# # inside a loop, kernel panics if this process gets killed
# # 'exec getty' could also work, but I liked to do it this way
# # For now this is not used.
# while true
# do
#     getty 0 tty0
# done
